-- Marketcheck Vehicle Listings Dataset Schema
-- Stores Marketcheck inventory search results with all listing fields.

CREATE TABLE IF NOT EXISTS marketcheck_listings (
    vin TEXT PRIMARY KEY,
    listing_id TEXT,
    heading TEXT,
    price INTEGER,
    miles INTEGER,
    msrp INTEGER,
    data_source TEXT NOT NULL,
    vdp_url TEXT,
    carfax_1_owner BOOLEAN,
    carfax_clean_title BOOLEAN,
    exterior_color TEXT,
    interior_color TEXT,
    base_int_color TEXT,
    base_ext_color TEXT,
    dom INTEGER,
    dom_180 INTEGER,
    dom_active INTEGER,
    dos_active INTEGER,
    seller_type TEXT,
    inventory_type TEXT,
    is_certified INTEGER,
    stock_no TEXT,
    last_seen_at INTEGER,
    last_seen_at_date TEXT,
    scraped_at INTEGER,
    scraped_at_date TEXT,
    first_seen_at INTEGER,
    first_seen_at_date TEXT,
    first_seen_at_source INTEGER,
    first_seen_at_source_date TEXT,
    first_seen_at_mc INTEGER,
    first_seen_at_mc_date TEXT,
    ref_price INTEGER,
    price_change_percent REAL,
    ref_price_dt INTEGER,
    ref_miles INTEGER,
    ref_miles_dt INTEGER,
    source TEXT,
    model_code TEXT,
    in_transit BOOLEAN,
    availability_status TEXT,
    financing_options_json TEXT,
    leasing_options_json TEXT,
    media_json TEXT,
    dealer_json TEXT,
    mc_dealership_json TEXT,
    build_json TEXT,
    build_year INTEGER,
    build_make TEXT,
    build_model TEXT,
    build_trim TEXT,
    build_version TEXT,
    build_body_type TEXT,
    build_vehicle_type TEXT,
    build_transmission TEXT,
    build_drivetrain TEXT,
    build_fuel_type TEXT,
    build_engine TEXT,
    build_doors INTEGER,
    build_cylinders INTEGER,
    build_std_seating TEXT,
    build_highway_mpg INTEGER,
    build_city_mpg INTEGER,
    dealer_name TEXT,
    dealer_city TEXT,
    dealer_state TEXT,
    dealer_zip TEXT,
    dealer_phone TEXT,
    dealer_latitude REAL,
    dealer_longitude REAL,
    dealer_country TEXT,
    dealer_type TEXT,
    dealer_msa_code TEXT,
    dist REAL,
    raw_json TEXT NOT NULL,
    fetched_at TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS marketcheck_zip_progress (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    zip_code TEXT NOT NULL,
    listings_fetched INTEGER DEFAULT 0,
    fetched_at TEXT NOT NULL,
    status TEXT DEFAULT 'completed',
    error_message TEXT,
    UNIQUE(zip_code)
);

CREATE INDEX IF NOT EXISTS idx_marketcheck_make_model ON marketcheck_listings(build_make, build_model);
CREATE INDEX IF NOT EXISTS idx_marketcheck_price ON marketcheck_listings(price);
CREATE INDEX IF NOT EXISTS idx_marketcheck_inventory_type ON marketcheck_listings(inventory_type);
CREATE INDEX IF NOT EXISTS idx_marketcheck_dealer_state ON marketcheck_listings(dealer_state);
CREATE INDEX IF NOT EXISTS idx_marketcheck_last_seen ON marketcheck_listings(last_seen_at);
